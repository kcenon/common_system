// BSD 3-Clause License
// Copyright (c) 2025, kcenon
// See the LICENSE file in the project root for full license information.

/**
 * @file abi_version.h
 * @brief ABI version information for common_system
 *
 * This file is automatically generated from abi_version.h.in by CMake.
 * DO NOT EDIT THIS FILE DIRECTLY - edit abi_version.h.in instead.
 *
 * ABI Version Format:
 * - Major version: Breaking changes
 * - Minor version: Compatible additions
 * - Patch version: Bug fixes
 *
 * Version encoding: 0xMMMMNNPP (Major, Minor, Patch)
 */

#pragma once

#include <cstdint>
#include <string_view>

namespace kcenon::common::abi {

// ============================================================================
// Version Information
// ============================================================================

/// Project version components
constexpr uint32_t version_major = @PROJECT_VERSION_MAJOR@;
constexpr uint32_t version_minor = @PROJECT_VERSION_MINOR@;
constexpr uint32_t version_patch = @PROJECT_VERSION_PATCH@;

/// Combined version number (0xMMMMNNPP)
constexpr uint32_t version =
    (version_major << 16) | (version_minor << 8) | version_patch;

/// Human-readable version string
constexpr std::string_view version_string = "@PROJECT_VERSION@";

// ============================================================================
// ABI-Specific Versions
// ============================================================================

/// Event bus ABI version
/// - Version 1: Standalone implementation (no monitoring_system dependency)
/// - Version 2: Reserved for future use
constexpr uint32_t event_bus_version = @EVENT_BUS_ABI_VERSION@;

// ============================================================================
// Build Configuration
// ============================================================================

/// Build timestamp
constexpr std::string_view build_timestamp = "@CMAKE_CONFIGURE_TIMESTAMP@";

/// Build type (Debug, Release, RelWithDebInfo, MinSizeRel)
constexpr std::string_view build_type = "@CMAKE_BUILD_TYPE@";

// ============================================================================
// ABI Compatibility Checking
// ============================================================================

/**
 * @brief Compile-time ABI version checker
 *
 * Use this template to verify ABI compatibility at compile time:
 * @code
 * // Require exact version match
 * abi_checker<0x00010000> check;
 * @endcode
 *
 * @tparam ExpectedVersion Expected ABI version (0xMMMMNNPP format)
 */
template<uint32_t ExpectedVersion>
struct abi_checker {
    static_assert(version == ExpectedVersion,
                  "ABI version mismatch detected! "
                  "Please recompile all modules with the same common_system version.");

    constexpr abi_checker() noexcept = default;
};

/**
 * @brief Runtime ABI version checker
 *
 * Use this for dynamic libraries that may be loaded at runtime.
 *
 * @param expected_version Expected ABI version
 * @return true if versions match, false otherwise
 */
constexpr bool check_abi_version(uint32_t expected_version) noexcept {
    return version == expected_version;
}

/**
 * @brief Check if two versions are compatible
 *
 * Two versions are compatible if:
 * - Major versions match exactly
 * - Current minor version >= required minor version
 *
 * @param required_version Minimum required version
 * @return true if compatible, false otherwise
 */
constexpr bool is_compatible(uint32_t required_version) noexcept {
    const uint32_t required_major = (required_version >> 16) & 0xFFFF;
    const uint32_t required_minor = (required_version >> 8) & 0xFF;

    return (version_major == required_major) &&
           (version_minor >= required_minor);
}

// ============================================================================
// Link-Time ABI Signature
// ============================================================================

/**
 * @brief Get unique ABI signature for link-time checking
 *
 * This function provides a unique symbol that changes with each ABI version.
 * Linker errors will occur if different ABI versions are linked together.
 *
 * @return Pointer to static ABI signature string
 */
extern "C" const char* get_abi_signature() noexcept;

/**
 * @brief Get detailed ABI information string
 *
 * Returns a human-readable string with version and configuration details.
 *
 * @return ABI information string
 */
const char* get_abi_info() noexcept;

/**
 * @brief Force link-time ABI check
 *
 * Call this function to ensure link-time ABI validation.
 * The linker will fail if different ABI versions are mixed.
 */
void require_abi_check() noexcept;

/**
 * @brief Version-specific link-time enforcer symbol
 *
 * This creates a unique symbol for each version that will cause
 * linker errors if different versions are present.
 * Do not call this directly - it's called automatically at static init time.
 */
extern "C" void kcenon_common_abi_link_v@PROJECT_VERSION_MAJOR@_@PROJECT_VERSION_MINOR@_@PROJECT_VERSION_PATCH@_ev@EVENT_BUS_ABI_VERSION@() noexcept;

} // namespace kcenon::common::abi
